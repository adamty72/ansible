---
- name: Scan for WordPress updates and apply them
  hosts: webservers
  become: yes
  vars:
    teams_webhook_url: "https://rocketwplimited.webhook.office.com/webhookb2/2185f0da-502f-4a3f-b435-3c14e7a154b3@4963f8a3-9dbf-444f-aed6-754777afe177/IncomingWebhook/cb802ad2fb9e486ca90ab6de2fc601c4/9ce1a27b-d314-4803-9bea-b449036d1b9f/V2z-Vu5hxujeqBUwjGTxHS_7vFEYy54A3xXTD0ksyS7oI1"
    log_file: "/var/log/wp_update_failures.log"
  tasks:
    - name: Find WordPress installations
      find:
        paths: /var/www
        patterns: wp-config.php
        recurse: yes
      register: wp_sites

    - name: Extract WordPress site subdirectory names
      set_fact:
        wp_sites_info: "{{ wp_sites.files | map(attribute='path') | map('dirname') | list | unique | list }}"
        site_names: "{{ wp_sites.files | map(attribute='path') | map('dirname') | map('basename') | list | unique | list }}"

    - name: Update WordPress plugins site by site
      block:
        - name: Update WordPress plugins for each site
          shell: |
            gp wp {{ wp_sites_info[site_index] }} plugin list --field=name --status=active --update=available | xargs -I {} gp wp {{ wp_sites_info[site_index] }} plugin update {}
          register: update_result
          ignore_errors: yes
          loop: "{{ site_names }}"
          loop_control:
            loop_var: site
            index_var: site_index

        - name: Report update result for each site
          debug:
            msg: "Update result for {{ site }}: {{ update_result.results[site_index].stdout }}"
          loop: "{{ site_names }}"
          loop_control:
            loop_var: site
            index_var: site_index

        - name: Log failed updates for each site
          lineinfile:
            path: "{{ log_file }}"
            line: "Failed update on site {{
